{{#fill_section 'css'}}
<link rel="stylesheet" href="/statics/css/teacher/teacher-create-course.css">
<link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
{{/fill_section}}

<section class="teacher-header">
  <div class="container">
    <h1 class="mb-2">Tạo khóa học mới</h1>
    <p class="mb-0 opacity-75">Chia sẻ kiến thức và kinh nghiệm của bạn với học viên</p>
  </div>
</section>

<section class="py-5">
  <div class="container create-course-form">
    <form id="createCourseForm">
      <div class="form-section">
        <h3 class="form-section-title">Thông tin cơ bản</h3>

        <div class="mb-3">
          <label class="form-label fw-bold">Tên khóa học *</label>
          <input type="text" class="form-control" id="courseTitle" required
                 placeholder="VD: Lập trình Python từ cơ bản đến nâng cao">
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Mô tả ngắn *</label>
          <textarea class="form-control" id="shortDescription" rows="3" required
                    placeholder="Mô tả ngắn gọn về khóa học (tối đa 200 ký tự)"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Lĩnh vực *</label>
          <select class="form-select" id="category" required>
            <option value="">-- Chọn lĩnh vực --</option>
            {{#each categories}}
            <option value="{{id}}">{{name}}</option>
            {{/each}}
          </select>
        </div>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">Giá gốc (VNĐ) *</label>
            <input type="number" class="form-control" id="price" required min="0">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Giá khuyến mại (VNĐ)</label>
            <input type="number" class="form-control" id="discountPrice" min="0">
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">Trạng thái</label>
            <select class="form-select" id="status">
              <option value="draft">Bản nháp</option>
              <option value="incomplete">Chưa hoàn thành</option>
              <option value="published">Đã xuất bản</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3 class="form-section-title">Ảnh đại diện khóa học</h3>
        <div class="image-upload-area" onclick="document.getElementById('thumbnailInput').click()">
          <i class="bi bi-cloud-upload"></i>
          <p class="mb-0">Click để tải ảnh lên hoặc nhập URL</p>
          <small class="text-muted">Kích thước khuyến nghị: 1280x720px</small>
        </div>
        <input type="file" id="thumbnailInput" class="d-none" accept="image/*">
        <input type="url" class="form-control mt-3" id="thumbnailUrl" placeholder="Hoặc nhập URL ảnh">
        <img id="thumbnailPreview" class="image-preview d-none">
      </div>

      <div class="form-section">
        <h3 class="form-section-title">Mô tả chi tiết</h3>
        <div id="editor" class="wysiwyg-editor"></div>
      </div>

      <div class="form-section">
        <h3 class="form-section-title">Nội dung khóa học</h3>
        <p class="text-muted">Tổ chức khóa học thành các chương và bài giảng</p>

        <div id="sectionsContainer"></div>

        <button type="button" class="btn btn-outline-primary" onclick="addSection()">
          <i class="bi bi-plus-lg"></i> Thêm chương
        </button>
      </div>

      <div class="d-flex gap-3 justify-content-end">
        <a href="/teacher/courses" class="btn btn-outline-secondary">Hủy</a>
        <button type="submit" class="btn btn-success">Tạo khóa học</button>
      </div>
    </form>
  </div>
</section>

{{#fill_section 'js'}}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
  const quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link', 'image'],
        ['clean']
      ]
    },
    placeholder: 'Nhập mô tả chi tiết về khóa học...'
  });

  let sectionCount = 0;

  function addSection() {
    sectionCount++;
    const html = `
      <div class="section-builder border rounded p-3 mb-3" id="section-${sectionCount}">
        <div class="section-header-input mb-3">
          <label class="form-label fw-bold">Tên chương ${sectionCount} *</label>
          <input type="text" class="form-control section-title" placeholder="Nhập tên chương" required>
          <div class="d-flex gap-2 mt-2">
            <button type="button" class="btn btn-sm btn-primary" onclick="addLecture(${sectionCount})">
              <i class="bi bi-plus"></i> Thêm bài giảng
            </button>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeSection(${sectionCount})">
              <i class="bi bi-trash"></i> Xóa chương
            </button>
          </div>
        </div>
        <div class="lecture-list" id="lectures-${sectionCount}">
          <p class="text-muted text-center small">Chưa có bài giảng</p>
        </div>
      </div>
    `;
    document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', html);
  }

  function addLecture(sectionId) {
    const lectureTitle = prompt('Nhập tên bài giảng:');
    if (!lectureTitle) return;

    const videoUrl = prompt('Nhập URL video (YouTube, Vimeo, hoặc URL trực tiếp):');
    if (!videoUrl) return;

    const duration = prompt('Nhập thời lượng (giây) - để trống nếu chưa biết:') || '0';
    const isPreview = confirm('Cho phép xem trước miễn phí?');
    
    const lectureList = document.getElementById(`lectures-${sectionId}`);
    if (lectureList.querySelector('.text-muted')) {
      lectureList.innerHTML = '';
    }

    const html = `
      <div class="lecture-item-builder border rounded p-2 mb-2 d-flex justify-content-between align-items-start" data-title="${lectureTitle}" data-video="${videoUrl}" data-duration="${duration}" data-preview="${isPreview}">
        <div class="flex-grow-1">
          <div class="fw-bold">${lectureTitle}</div>
          <div class="small text-muted">
            <i class="bi bi-play-circle"></i> ${videoUrl}
            ${duration && duration !== '0' ? `<br><i class="bi bi-clock"></i> ${duration} giây` : ''}
            ${isPreview ? '<br><span class="badge bg-info">Preview</span>' : ''}
          </div>
        </div>
        <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    `;
    lectureList.insertAdjacentHTML('beforeend', html);
  }

  function removeSection(sectionId) {
    if (confirm('Bạn có chắc muốn xóa chương này?')) {
      document.getElementById(`section-${sectionId}`).remove();
    }
  }

  document.getElementById('thumbnailUrl').addEventListener('input', (e) => {
    const preview = document.getElementById('thumbnailPreview');
    if (e.target.value) {
      preview.src = e.target.value;
      preview.classList.remove('d-none');
    } else {
      preview.classList.add('d-none');
    }
  });

  document.getElementById('createCourseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const title = document.getElementById('courseTitle').value.trim();
    const short_description = document.getElementById('shortDescription').value.trim();
    const category_id = document.getElementById('category').value;
    const price = parseFloat(document.getElementById('price').value) || 0;
    const discount_price = document.getElementById('discountPrice').value ? parseFloat(document.getElementById('discountPrice').value) : null;
    const status = document.getElementById('status').value || 'draft';
    const thumbnail_url = document.getElementById('thumbnailUrl').value.trim();
    const detailed_description = quill.root.innerHTML;

    // Collect sections and lectures
    const sections = [];
    const sectionElements = document.querySelectorAll('.section-builder');
    sectionElements.forEach((sectionEl, index) => {
      const sectionTitle = sectionEl.querySelector('.section-title').value.trim();
      
      if (!sectionTitle) return; // Skip empty sections
      
      const lectures = [];
      const lectureElements = sectionEl.querySelectorAll('.lecture-item-builder');
      lectureElements.forEach(lectureEl => {
        const lectureTitle = lectureEl.dataset.title;
        const videoUrl = lectureEl.dataset.video;
        const duration = parseInt(lectureEl.dataset.duration) || 0;
        const isPreview = lectureEl.dataset.preview === 'true';
        
        if (lectureTitle && videoUrl) {
          lectures.push({
            title: lectureTitle.trim(),
            video_url: videoUrl.trim(),
            duration: duration,
            is_preview: isPreview,
            order_index: lectures.length
          });
        }
      });
      
      sections.push({
        title: sectionTitle,
        order_index: index,
        lectures: lectures
      });
    });

    // Validation
    if (!title || !short_description || !category_id) {
      alert('Vui lòng điền đầy đủ các trường bắt buộc: Tên khóa học, Mô tả ngắn, và Lĩnh vực!');
      return;
    }

    if (price < 0 || (discount_price !== null && discount_price < 0)) {
      alert('Giá không được là số âm!');
      return;
    }

    if (discount_price !== null && discount_price >= price) {
      alert('Giá khuyến mại phải nhỏ hơn giá gốc!');
      return;
    }

    try {
      const formData = {
        title,
        short_description,
        detailed_description,
        thumbnail_url,
        price,
        discount_price,
        category_id,
        status,
        sections: sections
      };

      const res = await fetch('/teacher/courses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      const data = await res.json();
      
      if (data.success) {
        alert('Tạo khóa học thành công!');
        window.location.href = `/teacher/course/${data.courseId}/manage`;
      } else {
        alert(data.message || 'Có lỗi xảy ra khi tạo khóa học!');
      }
    } catch (err) {
      console.error('Error:', err);
      alert('Có lỗi xảy ra khi tạo khóa học!');
    }
  });
</script>
{{/fill_section}}
