{{#fill_section 'css'}}
<link rel="stylesheet" href="/statics/css/course/course-list.css">
{{/fill_section}}

<div class="course-list-page">
  <div class="container py-5">
    <div class="row">
      <div class="col-lg-3">
        <div class="filters-sidebar">
          <h4 class="filter-title">L·ªçc theo</h4>

          <div class="filter-section">
            <h5>Lƒ©nh v·ª±c</h5>
            <div class="filter-options">
              {{#each categories}}
                <div class="mb-2">
                  <div class="form-check d-flex align-items-center gap-2">
                    <input class="form-check-input category-checkbox" type="checkbox" 
                           id="cat-{{id}}" 
                           value="{{id}}"
                          data-category-id="{{id}}"
                           data-has-children="{{#if children}}true{{else}}false{{/if}}"
                           {{#if (eq ../currentCategory id)}}checked{{/if}}>
                    <label class="form-check-label d-flex align-items-center gap-2 flex-grow-1 category-label"
                           for="cat-{{id}}">
                    {{#if children}}
                        <button class="btn btn-link p-0 toggle-icon-btn" type="button"
                                data-category-id="{{id}}">
                      <i class="bi bi-caret-right-fill toggle-icon {{#if (eq ../currentCategory id)}}rotated{{/if}}"></i>
                        </button>
                    {{else}}
                      <i class="bi bi-dot"></i>
                    {{/if}}
                    <span class="fw-semibold">{{name}}</span>
                    {{#if course_count}}<span class="text-muted small">({{course_count}})</span>{{/if}}
                    </label>
                  </div>

                  {{#if children}}
                    <div class="ms-4 mt-1 border-start ps-3 subcategory-list {{#unless (eq ../currentCategory id)}}d-none{{/unless}}"
                         id="subcats-{{id}}">
                      {{#each children}}
                        <div class="form-check mb-1">
                          <input class="form-check-input subcategory-checkbox" type="checkbox" 
                                 id="sub-{{id}}" 
                                 value="{{id}}"
                                 data-sub-id="{{id}}"
                                 data-parent-id="{{../id}}"
                                 {{#if (eq ../../currentSub id)}}checked{{/if}}>
                          <label class="form-check-label" for="sub-{{id}}">
                          {{name}}
                          {{#if course_count}}<span class="text-muted small"> ({{course_count}})</span>{{/if}}
                          </label>
                        </div>
                      {{/each}}
                    </div>
                  {{/if}}
                </div>
              {{/each}}
            </div>
          </div>

          <div class="filter-section">
            <h5>Gi√°</h5>
            <div class="filter-options">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="priceFilter" id="price-all" value="all" checked>
                <label class="form-check-label" for="price-all">
                  T·∫•t c·∫£
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="priceFilter" id="price-free" value="free">
                <label class="form-check-label" for="price-free">
                  Mi·ªÖn ph√≠
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="priceFilter" id="price-paid" value="paid">
                <label class="form-check-label" for="price-paid">
                  C√≥ ph√≠
                </label>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <h5>ƒê√°nh gi√°</h5>
            <div class="filter-options">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rating-4.5">
                <label class="form-check-label" for="rating-4.5">
                  ‚≠ê 4.5 tr·ªü l√™n
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rating-4">
                <label class="form-check-label" for="rating-4">
                  ‚≠ê 4.0 tr·ªü l√™n
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rating-3.5">
                <label class="form-check-label" for="rating-3.5">
                  ‚≠ê 3.5 tr·ªü l√™n
                </label>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <h5>S·∫Øp x·∫øp theo</h5>
            <div class="filter-options">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sortFilter" id="sort-popular" value="popular" {{#if (eq sortBy 'popular')}}checked{{/if}}>
                <label class="form-check-label" for="sort-popular">
                  Ph·ªï bi·∫øn
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sortFilter" id="sort-rating" value="rating" {{#if (eq sortBy 'rating')}}checked{{/if}}>
                <label class="form-check-label" for="sort-rating">
                  ƒê√°nh gi√° cao
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sortFilter" id="sort-newest" value="newest" {{#if (eq sortBy 'newest')}}checked{{/if}}>
                <label class="form-check-label" for="sort-newest">
                  M·ªõi nh·∫•t
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sortFilter" id="sort-price-low" value="price-low" {{#if (eq sortBy 'price-low')}}checked{{/if}}>
                <label class="form-check-label" for="sort-price-low">
                  Gi√°: Th·∫•p ‚Üí Cao
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sortFilter" id="sort-price-high" value="price-high" {{#if (eq sortBy 'price-high')}}checked{{/if}}>
                <label class="form-check-label" for="sort-price-high">
                  Gi√°: Cao ‚Üí Th·∫•p
                </label>
              </div>
            </div>
          </div>

          <button class="btn btn-outline-secondary w-100 mt-3" id="clearFilters">X√≥a b·ªô l·ªçc</button>
        </div>
      </div>

      <div class="col-lg-9">
        <div class="course-list-header">
          {{#if searchQuery}}
          <h2>K·∫øt qu·∫£ t√¨m ki·∫øm: "{{searchQuery}}"</h2>
          <p class="text-muted" id="courseCount">T√¨m th·∫•y {{courses.length}} kh√≥a h·ªçc</p>
          {{else}}
          <h2>Danh s√°ch kh√≥a h·ªçc</h2>
          <p class="text-muted" id="courseCount">{{courses.length}} kh√≥a h·ªçc</p>
          {{/if}}
        </div>

        <div class="courses-grid" id="coursesGrid">
          {{#each courses}}
          <div class="course-item">
            <a href="/courses/{{id}}" class="course-link">
              <div class="course-thumbnail">
                <img src="{{thumbnail_url}}" alt="{{title}}">
                <div class="course-badges">
                  {{#if is_featured}}
                  <span class="badge badge-featured">N·ªïi b·∫≠t</span>
                  {{/if}}
                  {{#if (isNew created_at)}}
                  <span class="badge badge-new">M·ªõi</span>
                  {{/if}}
                  {{#if (gt price discount_price)}}
                  <span class="badge badge-discount">Gi·∫£m gi√°</span>
                  {{/if}}
                {{#if (isBestSeller enrollment_count)}}
                <span class="badge badge-bestseller">Best Seller</span>
                {{/if}}
                </div>
              </div>
              <div class="course-content">
                <div class="course-category">{{category.name}}</div>
                <h5 class="course-title">{{title}}</h5>
                <p class="course-description">{{truncate short_description 100}}</p>
                <div class="course-teacher">
                  <img src="{{teacher.avatar_url}}" alt="{{teacher.full_name}}" class="teacher-avatar">
                  <span>{{teacher.full_name}}</span>
                </div>
                <div class="course-stats">
                  <span class="rating">P {{rating_avg}}</span>
                  <span class="rating-count">({{formatNumber rating_count}})</span>
                  <span class="students">" {{formatNumber enrollment_count}} h·ªçc vi√™n</span>
                </div>
                <div class="course-footer">
                  <div class="course-price">
                    <span class="price-current">{{formatCurrency discount_price}}</span>
                    <span class="price-original">{{formatCurrency price}}</span>
                    <span class="discount-badge">-{{calculateDiscount price discount_price}}%</span>
                  </div>
                  <button class="btn-wishlist" data-course-id="{{id}}">
                    <i class="bi bi-heart"></i>
                  </button>
                </div>
              </div>
            </a>
          </div>
          {{/each}}
        </div>

        {{#if (gt totalPages 1)}}
        <nav class="pagination-nav mt-5">
          <ul class="pagination justify-content-center">
            <li class="page-item {{#if (eq currentPage 1)}}disabled{{/if}}">
              <a class="page-link" href="?page={{math currentPage '-' 1}}{{#if searchQuery}}&q={{searchQuery}}{{/if}}{{#if currentCategory}}&category={{currentCategory}}{{/if}}{{#if currentSub}}&sub={{currentSub}}{{/if}}{{#if (ne sortBy 'popular')}}&sort={{sortBy}}{{/if}}">Tr∆∞·ªõc</a>
            </li>
            <li class="page-item {{#if (eq currentPage 1)}}active{{/if}}">
              <a class="page-link" href="?page=1{{#if searchQuery}}&q={{searchQuery}}{{/if}}{{#if currentCategory}}&category={{currentCategory}}{{/if}}{{#if currentSub}}&sub={{currentSub}}{{/if}}{{#if (ne sortBy 'popular')}}&sort={{sortBy}}{{/if}}">1</a>
            </li>
            {{#if (gt totalPages 1)}}
            <li class="page-item {{#if (eq currentPage 2)}}active{{/if}}">
              <a class="page-link" href="?page=2{{#if searchQuery}}&q={{searchQuery}}{{/if}}{{#if currentCategory}}&category={{currentCategory}}{{/if}}{{#if currentSub}}&sub={{currentSub}}{{/if}}{{#if (ne sortBy 'popular')}}&sort={{sortBy}}{{/if}}">2</a>
            </li>
            {{/if}}
            <li class="page-item {{#if (eq currentPage totalPages)}}disabled{{/if}}">
              <a class="page-link" href="?page={{math currentPage '+' 1}}{{#if searchQuery}}&q={{searchQuery}}{{/if}}{{#if currentCategory}}&category={{currentCategory}}{{/if}}{{#if currentSub}}&sub={{currentSub}}{{/if}}{{#if (ne sortBy 'popular')}}&sort={{sortBy}}{{/if}}">Sau</a>
            </li>
          </ul>
        </nav>
        {{/if}}
      </div>
    </div>
  </div>
</div>

{{#fill_section 'js'}}
<script>
// ========== GLOBAL STATE ==========
let currentFilters = {
  category: null,
  sub: null,
  sort: 'popular',
  min_price: null,
  max_price: null,
  page: 1
};

// ========== HELPER FUNCTIONS ==========
function formatCurrency(value) {
  return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
}

function formatNumber(value) {
  return new Intl.NumberFormat('vi-VN').format(value);
}

function truncate(str, length) {
  if (!str || str.length <= length) return str;
  return str.substring(0, length) + '...';
}

function isBestSeller(enrollmentCount) {
  return enrollmentCount > 1000;
}

function isNew(createdAt) {
  if (!createdAt) return false;
  const created = new Date(createdAt);
  const now = new Date();
  const daysDiff = (now - created) / (1000 * 60 * 60 * 24);
  return daysDiff <= 7; // M·ªõi trong 7 ng√†y
}

function calculateDiscount(price, discountPrice) {
  if (!discountPrice || discountPrice >= price) return 0;
  return Math.round(((price - discountPrice) / price) * 100);
}

// ========== BUILD FILTER PARAMS ==========
function buildFilterParams() {
  const params = new URLSearchParams();

  // üü£ CATEGORY + SUB
  const selectedCategories = [];
  const selectedSubs = [];
  document.querySelectorAll('.category-checkbox:checked').forEach(cb => {
    const id = cb.dataset.categoryId;
    const hasChildren = cb.dataset.hasChildren === 'true';
    if (hasChildren) {
      const subList = document.getElementById(`subcats-${id}`);
      const checkedSubs = subList ? 
        Array.from(subList.querySelectorAll('.subcategory-checkbox:checked')).map(s => s.value) : [];
      if (checkedSubs.length === 0) selectedCategories.push(id);
      else selectedSubs.push(...checkedSubs);
    } else selectedCategories.push(id);
  });

  if (selectedSubs.length > 0) params.set('sub', selectedSubs.join(','));
  else if (selectedCategories.length > 0) params.set('category', selectedCategories.join(','));

  // üü£ SORT
  const sortRadio = document.querySelector('input[name="sortFilter"]:checked');
  if (sortRadio) params.set('sort', sortRadio.value);

  // üü£ PRICE
  const priceFilter = document.querySelector('input[name="priceFilter"]:checked')?.value;
  if (priceFilter === 'free') {
    params.set('min_price', '0');
    params.set('max_price', '0');
  } else if (priceFilter === 'paid') {
    params.set('min_price', '1');
  }

  // üü£ RATING
  const ratingFilters = [];
  if (document.getElementById('rating-4.5')?.checked) ratingFilters.push(4.5);
  if (document.getElementById('rating-4')?.checked) ratingFilters.push(4.0);
  if (document.getElementById('rating-3.5')?.checked) ratingFilters.push(3.5);
  if (ratingFilters.length > 0) params.set('min_rating', Math.min(...ratingFilters));

  params.set('page', '1');
  return params;
}

// ========== FETCH COURSES VIA API ==========
async function fetchCourses() {
  const params = buildFilterParams();
  const url = `/api/courses?${params.toString()}`;
  
  try {
    const coursesGrid = document.getElementById('coursesGrid');
    const courseCount = document.getElementById('courseCount');
    
    // Show loading
    coursesGrid.innerHTML = '<div class="text-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    const res = await fetch(url);
    const data = await res.json();
    
    if (!data.success) {
      throw new Error(data.message || 'L·ªói t·∫£i d·ªØ li·ªáu');
    }
    
    // Update course count
    if (courseCount) {
      courseCount.textContent = `${data.courses.length} kh√≥a h·ªçc`;
    }
    
    // Update courses grid
    if (data.courses.length === 0) {
      coursesGrid.innerHTML = '<div class="text-center p-5"><p class="text-muted">Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc n√†o</p></div>';
      return;
    }
    
    coursesGrid.innerHTML = data.courses.map(course => `
      <div class="course-item">
        <a href="/courses/${course.id}" class="course-link">
          <div class="course-thumbnail">
            <img src="${course.thumbnail_url || ''}" alt="${course.title}">
            <div class="course-badges">
              ${course.is_featured ? '<span class="badge badge-featured">N·ªïi b·∫≠t</span>' : ''}
              ${isNew(course.created_at) ? '<span class="badge badge-new">M·ªõi</span>' : ''}
              ${course.price > course.discount_price ? '<span class="badge badge-discount">Gi·∫£m gi√°</span>' : ''}
              ${isBestSeller(course.enrollment_count) ? '<span class="badge badge-bestseller">Best Seller</span>' : ''}
            </div>
          </div>
          <div class="course-content">
            <div class="course-category">${course.category?.name || ''}</div>
            <h5 class="course-title">${course.title}</h5>
            <p class="course-description">${truncate(course.short_description || '', 100)}</p>
            <div class="course-teacher">
              <img src="${course.teacher?.avatar_url || ''}" alt="${course.teacher?.full_name || ''}" class="teacher-avatar">
              <span>${course.teacher?.full_name || ''}</span>
            </div>
            <div class="course-stats">
              <span class="rating">‚≠ê ${course.rating_avg || 0}</span>
              <span class="rating-count">(${formatNumber(course.rating_count || 0)})</span>
              <span class="students">üë• ${formatNumber(course.enrollment_count || 0)} h·ªçc vi√™n</span>
            </div>
            <div class="course-footer">
              <div class="course-price">
                <span class="price-current">${formatCurrency(course.discount_price || course.price || 0)}</span>
                ${course.price > course.discount_price ? `<span class="price-original">${formatCurrency(course.price)}</span><span class="discount-badge">-${calculateDiscount(course.price, course.discount_price)}%</span>` : ''}
              </div>
              <button class="btn-wishlist" data-course-id="${course.id}">
                <i class="bi bi-heart"></i>
              </button>
            </div>
          </div>
        </a>
      </div>
    `).join('');
    
    // Update pagination
    updatePagination(data.pagination);
    
    // Re-attach wishlist handlers
    attachWishlistHandlers();
    
  } catch (error) {
    console.error('Fetch courses error:', error);
    document.getElementById('coursesGrid').innerHTML = '<div class="text-center p-5"><p class="text-danger">L·ªói t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.</p></div>';
  }
}

// ========== UPDATE PAGINATION ==========
function updatePagination(pagination) {
  const paginationNav = document.querySelector('.pagination-nav');
  if (!paginationNav || pagination.totalPages <= 1) {
    if (paginationNav) paginationNav.style.display = 'none';
    return;
  }
  
  paginationNav.style.display = 'block';
  // TODO: Implement pagination update (c√≥ th·ªÉ th√™m sau n·∫øu c·∫ßn)
}

// ========== EVENT HANDLERS ==========
// Category checkbox toggle (expand/collapse)
document.querySelectorAll('.toggle-icon-btn').forEach(btn => {
  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    const categoryId = this.dataset.categoryId;
    const subList = document.getElementById(`subcats-${categoryId}`);
    const toggleIcon = this.querySelector('.toggle-icon');
    
    if (subList) {
      subList.classList.toggle('d-none');
      toggleIcon?.classList.toggle('rotated');
    }
  });
});

// Category checkbox - g·ªçi API khi thay ƒë·ªïi
document.querySelectorAll('.category-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const categoryId = this.dataset.categoryId;
    const hasChildren = this.dataset.hasChildren === 'true';
    const subList = document.getElementById(`subcats-${categoryId}`);

    if (hasChildren && subList && this.checked && subList.classList.contains('d-none')) {
      subList.classList.remove('d-none');
      document.querySelector(`[data-category-id="${categoryId}"].toggle-icon`)?.classList.add('rotated');
    }
    
    // G·ªçi API ngay
    fetchCourses();
  });
});

// Subcategory checkbox - g·ªçi API khi thay ƒë·ªïi
document.querySelectorAll('.subcategory-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    fetchCourses();
  });
});

// Sort radio - g·ªçi API khi thay ƒë·ªïi
document.querySelectorAll('input[name="sortFilter"]').forEach(radio => {
  radio.addEventListener('change', function() {
    fetchCourses();
  });
});

// Price filter - g·ªçi API khi thay ƒë·ªïi
document.querySelectorAll('input[name="priceFilter"]').forEach(radio => {
  radio.addEventListener('change', function() {
    fetchCourses();
  });
});

// Rating filter (c√≥ th·ªÉ th√™m sau n·∫øu c·∫ßn)
document.querySelectorAll('#rating-4.5, #rating-4, #rating-3.5').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    fetchCourses();
  });
});

// ========== CLEAR FILTERS ==========
document.getElementById('clearFilters')?.addEventListener('click', function() {
  // Uncheck t·∫•t c·∫£ checkboxes v√† radio buttons
  document.querySelectorAll('.category-checkbox, .subcategory-checkbox').forEach(cb => cb.checked = false);
  document.querySelectorAll('input[name="priceFilter"]').forEach(rb => {
    if (rb.value === 'all') rb.checked = true;
    else rb.checked = false;
  });
  document.querySelectorAll('input[name="sortFilter"]').forEach(rb => {
    if (rb.value === 'popular') rb.checked = true;
    else rb.checked = false;
  });
  document.querySelectorAll('#rating-4.5, #rating-4, #rating-3.5').forEach(cb => cb.checked = false);
  
  // ƒê√≥ng t·∫•t c·∫£ subcategory lists
  document.querySelectorAll('.subcategory-list').forEach(list => list.classList.add('d-none'));
  document.querySelectorAll('.toggle-icon').forEach(icon => icon.classList.remove('rotated'));
  
  // G·ªçi API v·ªõi filters ƒë√£ clear
  fetchCourses();
});

// ========== WISHLIST HANDLERS ==========
function attachWishlistHandlers() {
  // Remove old listeners tr∆∞·ªõc
  document.querySelectorAll('.btn-wishlist').forEach(btn => {
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
  });
  
  // Attach new listeners
document.querySelectorAll('.btn-wishlist').forEach(btn => {
    btn.addEventListener('click', async function(e) {
    e.preventDefault();
    e.stopPropagation();
    const courseId = this.dataset.courseId;
      
      if (!courseId) return;
      
      const res = await fetch(`/courses/${courseId}/wishlist`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      });
      
      if (res.status === 401) {
        window.location.href = '/signin';
        return;
      }
      
      const data = await res.json();
      if (data.success) {
        this.classList.add('active');
        this.innerHTML = '<i class="bi bi-heart-fill"></i>';
      } else {
        alert(data.message || 'C√≥ l·ªói x·∫£y ra.');
      }
  });
});
}

// Attach handlers khi page load
attachWishlistHandlers();
</script>
{{/fill_section}}