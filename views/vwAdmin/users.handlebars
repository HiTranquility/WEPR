{{#fill_section 'css'}}
<link rel="stylesheet" href="/statics/css/admin/admin-users.css">
{{/fill_section}}

<div class="admin-users-page">
  <div class="admin-header">
    <div class="container-fluid">
      <h2 class="mb-1">Quản lý người dùng</h2>
      <p class="mb-0 opacity-75">Quản lý học viên và giảng viên</p>
    </div>
  </div>
  
  <div class="container-fluid">
    <div class="data-table">
      <div class="table-toolbar">
        <h5 class="mb-0" id="usersCountLabel">Danh sách người dùng (<span id="usersCountNumber">{{users.length}}</span>)</h5>
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm" style="width: 150px;" onchange="filterByRole(this.value)">
            <option value="">Tất cả vai trò</option>
            <option value="student">Học viên</option>
            <option value="teacher">Giảng viên</option>
            <option value="admin">Quản trị viên</option>
          </select>
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-plus-lg"></i> Thêm người dùng
          </button>
        </div>
      </div>
  
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="usersTable">
          <thead class="table-light">
            <tr>
              <th style="width: 60px;">Avatar</th>
              <th>Họ tên</th>
              <th>Email</th>
              <th>Vai trò</th>
              <th>Trạng thái</th>
              <th>Ngày tham gia</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            {{#each users}}
            <tr data-user-id="{{id}}" data-role="{{role}}" data-status="{{status}}" data-name="{{full_name}}" data-email="{{email}}" data-created="{{formatDate created_at}}">
              <td>
                <img src="{{avatar_url}}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;" alt="{{full_name}}">
              </td>
              <td><strong>{{full_name}}</strong></td>
              <td>{{email}}</td>
              <td>
                <span class="badge bg-{{#if (eq role 'admin')}}danger{{else if (eq role 'teacher')}}success{{else}}primary{{/if}}">
                  {{#if (eq role 'admin')}}Quản trị viên
                  {{else if (eq role 'teacher')}}Giảng viên
                  {{else}}Học viên
                  {{/if}}
                </span>
              </td>
              <td>
                <span class="badge {{#if (eq status 'blocked')}}bg-danger{{else}}bg-primary-subtle text-primary-emphasis{{/if}}">
                  {{#if (eq status 'blocked')}}Đã khóa{{else}}Đang hoạt động{{/if}}
                </span>
              </td>
              <td>{{formatDate created_at}}</td>
              <td>
                <div class="action-buttons d-flex gap-1">
                  <button class="btn btn-sm btn-outline-primary" onclick="viewUser('{{id}}')" title="Xem chi tiết">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-warning" onclick="editUser('{{id}}')" title="Sửa">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm {{#if (eq status 'blocked')}}btn-outline-success{{else}}btn-outline-danger{{/if}}" 
                          onclick="toggleUserStatus('{{id}}')" 
                          title="{{#if (eq status 'blocked')}}Mở khóa{{else}}Khóa{{/if}}">
                    <i class="bi bi-{{#if (eq status 'blocked')}}unlock{{else}}lock{{/if}}"></i>
                  </button>
                  {{#if (ne role 'admin')}}
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('{{id}}')" title="Xóa">
                    <i class="bi bi-trash"></i>
                  </button>
                  {{/if}}
                </div>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>
  </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title">Thêm người dùng mới</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <form id="addUserForm">
      <div class="mb-3">
        <label class="form-label">Họ tên *</label>
        <input type="text" class="form-control" id="fullName" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email *</label>
        <input type="email" class="form-control" id="email" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Mật khẩu *</label>
        <input type="password" class="form-control" id="password" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Vai trò *</label>
        <select class="form-select" id="role" required>
          <option value="student">Học viên</option>
          <option value="teacher">Giảng viên</option>
          <option value="admin">Quản trị viên</option>
        </select>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
    <button type="button" class="btn btn-primary" onclick="saveUser()">Lưu</button>
  </div>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title">Sửa thông tin người dùng</h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
  </div>
  <div class="modal-body">
    <form id="editUserForm">
      <input type="hidden" id="editUserId">
      <div class="mb-3">
        <label class="form-label">Họ tên *</label>
        <input type="text" class="form-control" id="editFullName" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email *</label>
        <input type="email" class="form-control" id="editEmail" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Vai trò *</label>
        <select class="form-select" id="editRole" required>
          <option value="student">Học viên</option>
          <option value="teacher">Giảng viên</option>
          <option value="admin">Quản trị viên</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Trạng thái *</label>
        <select class="form-select" id="editStatus" required>
          <option value="active">Đang hoạt động</option>
          <option value="blocked">Đã khóa</option>
        </select>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
    <button type="button" class="btn btn-primary" onclick="updateUser()">Cập nhật</button>
    </div>
  </div>
  
</div>

  <div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thông tin người dùng</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex align-items-center gap-3 mb-3">
            <img id="viewUserAvatar" src="" alt="Avatar" class="rounded-circle" style="width: 64px; height: 64px; object-fit: cover;">
            <div>
              <h5 class="mb-1" id="viewUserName"></h5>
              <span class="badge" id="viewUserRole"></span>
            </div>
          </div>
          <dl class="row mb-0">
            <dt class="col-sm-4">Email</dt>
            <dd class="col-sm-8" id="viewUserEmail"></dd>
            <dt class="col-sm-4">Trạng thái</dt>
            <dd class="col-sm-8" id="viewUserStatus"></dd>
            <dt class="col-sm-4">Ngày tham gia</dt>
            <dd class="col-sm-8" id="viewUserCreated"></dd>
          </dl>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>

{{#fill_section 'js'}}
<script>
  const notifications = {
    show(message, variant = 'success') {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="alert alert-${variant} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow" role="alert" style="z-index:1055; min-width:260px;">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      const alertEl = wrapper.firstElementChild;
      document.body.appendChild(alertEl);
      setTimeout(() => {
        if (alertEl) bootstrap.Alert.getOrCreateInstance(alertEl).close();
      }, 4000);
    }
  };

  const roleLabels = {
    admin: { text: 'Quản trị viên', badge: 'bg-danger' },
    teacher: { text: 'Giảng viên', badge: 'bg-success' },
    student: { text: 'Học viên', badge: 'bg-primary' }
  };

  function filterByRole(role) {
    const rows = document.querySelectorAll('#usersTableBody tr');
    rows.forEach(row => {
      if (!role || row.dataset.role === role) {
        row.classList.remove('d-none');
      } else {
        row.classList.add('d-none');
      }
    });
  }

  async function saveUser() {
    const fullName = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;

    if (!fullName || !email || !password) {
      return notifications.show('Vui lòng nhập đầy đủ thông tin bắt buộc.', 'warning');
    }

    try {
      const res = await fetch('/admin/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ full_name: fullName, email, password, role })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Không thể tạo người dùng.');

      notifications.show('Tạo người dùng mới thành công!');
      document.getElementById('addUserForm').reset();
      bootstrap.Modal.getInstance(document.getElementById('addUserModal'))?.hide();
      setTimeout(() => window.location.reload(), 800);
    } catch (err) {
      notifications.show(err.message || 'Có lỗi xảy ra khi tạo người dùng.', 'danger');
    }
  }

  function viewUser(userId) {
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    if (!row) return;

    const role = row.dataset.role;
    const status = row.dataset.status || 'active';

    document.getElementById('viewUserAvatar').src = row.querySelector('img')?.src || '';
    document.getElementById('viewUserName').textContent = row.dataset.name || '';
    document.getElementById('viewUserEmail').textContent = row.dataset.email || '';
    document.getElementById('viewUserStatus').textContent = status === 'blocked' ? 'Đã khóa tài khoản' : 'Đang hoạt động';
    document.getElementById('viewUserCreated').textContent = row.dataset.created || '';

    const roleBadge = roleLabels[role] || roleLabels.student;
    const badgeEl = document.getElementById('viewUserRole');
    badgeEl.className = `badge ${roleBadge.badge}`;
    badgeEl.textContent = roleBadge.text;

    new bootstrap.Modal(document.getElementById('viewUserModal')).show();
  }

  function editUser(id) {
    const row = document.querySelector(`tr[data-user-id="${id}"]`);
    if (!row) return;
    const status = row?.dataset.status || 'active';

    document.getElementById('editUserId').value = id;
    document.getElementById('editFullName').value = row.dataset.name || '';
    document.getElementById('editEmail').value = row.dataset.email || '';
    document.getElementById('editRole').value = row.dataset.role || 'student';
    document.getElementById('editStatus').value = status;

    new bootstrap.Modal(document.getElementById('editUserModal')).show();
  }

  async function updateUser() {
    const id = document.getElementById('editUserId').value;
    const full_name = document.getElementById('editFullName').value.trim();
    const email = document.getElementById('editEmail').value.trim();
    const role = document.getElementById('editRole').value;
    const status = document.getElementById('editStatus').value;

    if (!id || !full_name || !email) {
      return notifications.show('Vui lòng điền đầy đủ thông tin.', 'warning');
    }

    try {
      const res = await fetch(`/admin/users/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ full_name, email, role, status })
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Không thể cập nhật người dùng.');

      const row = document.querySelector(`tr[data-user-id="${id}"]`);
      if (row) {
        row.dataset.name = full_name;
        row.dataset.email = email;
        row.dataset.role = role;
        row.dataset.status = status;

        row.querySelector('td:nth-child(2) strong').textContent = full_name;
        row.querySelector('td:nth-child(3)').textContent = email;

        const roleBadge = roleLabels[role] || roleLabels.student;
        const roleSpan = row.querySelector('td:nth-child(4) span');
        roleSpan.className = `badge ${roleBadge.badge}`;
        roleSpan.textContent = roleBadge.text;

        const statusSpan = row.querySelector('td:nth-child(5) span');
        statusSpan.className = `badge ${status === 'blocked' ? 'bg-danger' : 'bg-primary-subtle text-primary-emphasis'}`;
        statusSpan.textContent = status === 'blocked' ? 'Đã khóa' : 'Đang hoạt động';
      }

      notifications.show('Cập nhật người dùng thành công!');
      bootstrap.Modal.getInstance(document.getElementById('editUserModal'))?.hide();
    } catch (err) {
      notifications.show(err.message || 'Có lỗi xảy ra khi cập nhật.', 'danger');
    }
  }

  async function toggleUserStatus(userId) {
    try {
      const res = await fetch(`/admin/users/${userId}/toggle-status`, { method: 'POST' });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Không thể thay đổi trạng thái.');

      const row = document.querySelector(`tr[data-user-id="${userId}"]`);
      if (row) {
        const currentStatus = row.dataset.status;
        const newStatus = currentStatus === 'blocked' ? 'active' : 'blocked';
        row.dataset.status = newStatus;

        const statusSpan = row.querySelector('td:nth-child(5) span');
        statusSpan.className = `badge ${newStatus === 'blocked' ? 'bg-danger' : 'bg-primary-subtle text-primary-emphasis'}`;
        statusSpan.textContent = newStatus === 'blocked' ? 'Đã khóa' : 'Đang hoạt động';

        const toggleBtn = row.querySelector('button[onclick*="toggleUserStatus"]');
        if (toggleBtn) {
          toggleBtn.className = `btn btn-sm ${newStatus === 'blocked' ? 'btn-outline-success' : 'btn-outline-danger'}`;
          toggleBtn.title = newStatus === 'blocked' ? 'Mở khóa' : 'Khóa';
          const icon = toggleBtn.querySelector('i');
          if (icon) icon.className = `bi bi-${newStatus === 'blocked' ? 'unlock' : 'lock'}`;
        }
      }

      notifications.show(data.message || 'Đã thay đổi trạng thái thành công!');
    } catch (err) {
      notifications.show(err.message || 'Có lỗi xảy ra.', 'danger');
    }
  }

  async function deleteUser(userId) {
    const row = document.querySelector(`tr[data-user-id="${userId}"]`);
    const fullName = row?.dataset.name || 'người dùng';
    if (!confirm(`Bạn có chắc muốn xóa người dùng "${fullName}"?`)) return;

    try {
      const res = await fetch(`/admin/users/${userId}`, { method: 'DELETE' });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Không thể xóa người dùng.');

      const row = document.querySelector(`tr[data-user-id="${userId}"]`);
      row?.remove();
      const countEl = document.getElementById('usersCountNumber');
      if (countEl) countEl.textContent = document.querySelectorAll('#usersTableBody tr').length;
      notifications.show('Đã xóa người dùng thành công!');
    } catch (err) {
      notifications.show(err.message || 'Có lỗi xảy ra khi xóa người dùng.', 'danger');
    }
  }
</script>
{{/fill_section}}
