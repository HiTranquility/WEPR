{{#fill_section 'css'}}
<link rel="stylesheet" href="/statics/css/admin/admin-courses.css">
{{/fill_section}}

<div class="admin-courses-page">
  <div class="admin-header">
    <div class="container-fluid">
      <h2 class="mb-1">Quản lý khóa học</h2>
      <p class="mb-0 opacity-75">Quản lý tất cả khóa học trên hệ thống</p>
    </div>
  </div>
  
  <div class="container-fluid">
    <div class="data-table">
      <div class="table-toolbar">
        <h5 class="mb-0">Danh sách khóa học (<span id="coursesCount">{{courses.length}}</span>)</h5>
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm" style="width: 200px;" onchange="filterByCategory(this.value)">
            <option value="">Tất cả lĩnh vực</option>
            {{#each categories}}
            <option value="{{id}}">{{name}}</option>
            {{/each}}
          </select>
          <select class="form-select form-select-sm" style="width: 200px;" onchange="filterByTeacher(this.value)" id="teacherFilter">
            <option value="">Tất cả giảng viên</option>
            {{#each teachers}}
            <option value="{{id}}">{{full_name}}</option>
            {{/each}}
          </select>
          <select class="form-select form-select-sm" style="width: 150px;" onchange="filterByStatus(this.value)">
            <option value="">Tất cả trạng thái</option>
            <option value="completed">Đã hoàn thành</option>
            <option value="draft">Bản nháp</option>
            <option value="suspended">Đã đình chỉ</option>
          </select>
        </div>
      </div>
  
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="coursesTable">
          <thead class="table-light">
            <tr>
              <th style="width: 60px;">Ảnh</th>
              <th>Tên khóa học</th>
              <th>Giảng viên</th>
              <th>Lĩnh vực</th>
              <th>Trạng thái</th>
              <th>Học viên</th>
              <th>Giá</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="coursesTableBody">
            {{#each courses}}
            <tr data-course-id="{{id}}" data-category="{{category.id}}" data-status="{{status}}" data-teacher="{{teacher.id}}">
              <td>
                <img src="{{thumbnail_url}}" class="rounded" style="width: 50px; height: 30px; object-fit: cover;" alt="{{title}}">
              </td>
              <td>
                <strong>{{truncate title 50}}</strong><br>
                <small class="text-muted">⭐ {{rating_avg}} ({{formatNumber rating_count}})</small>
              </td>
              <td>{{teacher.full_name}}</td>
              <td><span class="badge bg-primary">{{category.name}}</span></td>
              <td>
                <span class="badge bg-{{#if (eq status 'completed')}}success{{else if (eq status 'draft')}}warning{{else if (eq status 'suspended')}}danger{{else}}secondary{{/if}}">
                  {{#if (eq status 'completed')}}Đã hoàn thành
                  {{else if (eq status 'draft')}}Bản nháp
                  {{else if (eq status 'suspended')}}Đã đình chỉ
                  {{else}}Chưa hoàn thành
                  {{/if}}
                </span>
              </td>
              <td>{{formatNumber enrollment_count}}</td>
              <td>{{formatCurrency discount_price}}</td>
              <td>
                <div class="action-buttons d-flex gap-1">
                  <a href="/courses/{{id}}" class="btn btn-sm btn-outline-primary" target="_blank" title="Xem">
                    <i class="bi bi-eye"></i>
                  </a>
                  <button class="btn btn-sm {{#if (eq status 'suspended')}}btn-outline-success{{else}}btn-outline-warning{{/if}}" 
                          onclick="toggleCourseStatus('{{id}}')" 
                          title="{{#if (eq status 'suspended')}}Kích hoạt{{else}}Đình chỉ{{/if}}">
                    <i class="bi bi-{{#if (eq status 'suspended')}}check-circle{{else}}x-circle{{/if}}"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" onclick="removeCourse('{{id}}', '{{title}}')" title="Xóa">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>
    </div>
  </div>
  
</div>
{{#fill_section 'js'}}
<script>
  const courseNotifications = {
    show(message, variant = 'success') {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="alert alert-${variant} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow" role="alert" style="z-index:1055; min-width:260px;">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      const alertEl = wrapper.firstElementChild;
      document.body.appendChild(alertEl);
      setTimeout(() => {
        if (alertEl) bootstrap.Alert.getOrCreateInstance(alertEl).close();
      }, 4000);
    }
  };

  function updateCourseCount() {
    const rows = document.querySelectorAll('#coursesTableBody tr:not(.d-none)');
    const label = document.getElementById('coursesCount');
    if (label) label.textContent = rows.length;
  }

  function filterByCategory(categoryId) {
    const rows = document.querySelectorAll('#coursesTableBody tr');
    rows.forEach(row => {
      const match = !categoryId || row.dataset.category === categoryId;
      row.dataset.categoryVisible = match ? '1' : '0';
      applyAllFilters(row);
    });
    updateCourseCount();
  }

  function filterByTeacher(teacherId) {
    const rows = document.querySelectorAll('#coursesTableBody tr');
    rows.forEach(row => {
      const match = !teacherId || row.dataset.teacher === teacherId;
      row.dataset.teacherVisible = match ? '1' : '0';
      applyAllFilters(row);
    });
    updateCourseCount();
  }

  function filterByStatus(status) {
    const rows = document.querySelectorAll('#coursesTableBody tr');
    rows.forEach(row => {
      const match = !status || row.dataset.status === status;
      row.dataset.statusVisible = match ? '1' : '0';
      applyAllFilters(row);
    });
    updateCourseCount();
  }

  function applyAllFilters(row) {
    const categoryVisible = row.dataset.categoryVisible !== '0';
    const teacherVisible = row.dataset.teacherVisible !== '0';
    const statusVisible = row.dataset.statusVisible !== '0';
    row.classList.toggle('d-none', !(categoryVisible && teacherVisible && statusVisible));
  }

  async function toggleCourseStatus(courseId) {
    try {
      const res = await fetch(`/admin/courses/${courseId}/toggle-status`, { method: 'POST' });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Không thể thay đổi trạng thái.');

      const row = document.querySelector(`tr[data-course-id="${courseId}"]`);
      if (row) {
        const currentStatus = row.dataset.status;
        const newStatus = currentStatus === 'completed' ? 'suspended' : 'completed';
        row.dataset.status = newStatus;

        const statusSpan = row.querySelector('td:nth-child(5) span');
        statusSpan.className = `badge bg-${newStatus === 'completed' ? 'success' : 'danger'}`;
        statusSpan.textContent = newStatus === 'completed' ? 'Đã hoàn thành' : 'Đã đình chỉ';

        const toggleBtn = row.querySelector('button[onclick*="toggleCourseStatus"]');
        if (toggleBtn) {
          toggleBtn.className = `btn btn-sm ${newStatus === 'completed' ? 'btn-outline-warning' : 'btn-outline-success'}`;
          toggleBtn.title = newStatus === 'completed' ? 'Đình chỉ' : 'Kích hoạt';
          const icon = toggleBtn.querySelector('i');
          if (icon) icon.className = `bi bi-${newStatus === 'completed' ? 'x-circle' : 'check-circle'}`;
        }
      }

      courseNotifications.show(data.message || 'Đã thay đổi trạng thái thành công!');
    } catch (err) {
      courseNotifications.show(err.message || 'Có lỗi xảy ra.', 'danger');
    }
  }

  async function removeCourse(courseId, courseTitle) {
    if (!confirm(`Bạn có chắc muốn gỡ bỏ khóa học "${courseTitle}"?\nKhóa học sẽ không còn hiển thị công khai.`)) return;

    try {
      const res = await fetch(`/admin/courses/${courseId}`, { method: 'DELETE' });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Không thể gỡ khóa học.');
      document.querySelector(`tr[data-course-id="${courseId}"]`)?.remove();
      courseNotifications.show('Đã gỡ khóa học thành công!');
      updateCourseCount();
    } catch (err) {
      courseNotifications.show(err.message || 'Có lỗi xảy ra khi gỡ khóa học.', 'danger');
    }
  }
</script>
{{/fill_section}}
