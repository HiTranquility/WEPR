{{#fill_section 'css'}}
<link rel="stylesheet" href="/statics/css/admin/admin-courses.css">
{{/fill_section}}

<div class="admin-courses-page">
  <div class="admin-header">
    <div class="container-fluid">
      <h2 class="mb-1">Quản lý khóa học</h2>
      <p class="mb-0 opacity-75">Quản lý tất cả khóa học trên hệ thống</p>
    </div>
  </div>

  <div class="container-fluid">
    <div class="data-table">
      <div class="table-toolbar">
        <h5 class="mb-0">Danh sách khóa học (<span id="coursesCount">{{courses.length}}</span>)</h5>
        <div class="d-flex gap-2">
          <select class="form-select form-select-sm" style="width: 200px;" onchange="filterByCategory(this.value)">
            <option value="">Tất cả lĩnh vực</option>
            {{#each categories}}
            <option value="{{id}}">{{name}}</option>
            {{/each}}
          </select>
          <select class="form-select form-select-sm" style="width: 200px;" onchange="filterByTeacher(this.value)">
            <option value="">Tất cả giảng viên</option>
            {{#each teachers}}
            <option value="{{id}}">{{full_name}}</option>
            {{/each}}
          </select>
          <select class="form-select form-select-sm" style="width: 150px;" onchange="filterByStatus(this.value)">
            <option value="">Tất cả trạng thái</option>
            <option value="published">Đã xuất bản</option>
            <option value="draft">Bản nháp</option>
            <option value="incomplete">Chưa hoàn thành</option>
          </select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover mb-0" id="coursesTable">
          <thead class="table-light">
            <tr>
              <th style="width: 60px;">Ảnh</th>
              <th>Tên khóa học</th>
              <th>Giảng viên</th>
              <th>Lĩnh vực</th>
              <th>Trạng thái</th>
              <th>Học viên</th>
              <th>Giá</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="coursesTableBody">
            {{#each courses}}
            {{!-- <tr data-course-id="{{id}}" data-category="{{category.id}}" data-status="{{status}}"
              data-teacher="{{teacher.id}}"> --}}
            <tr data-course-id="{{id}}" data-category="{{#if category.id}}{{category.id}}{{/if}}"
              data-status="{{status}}" data-teacher="{{teacher.id}}">
              <td>
                <img src="{{thumbnail_url}}" class="rounded" style="width: 50px; height: 30px; object-fit: cover;"
                  alt="{{title}}">
              </td>
              <td>
                <strong>{{truncate title 50}}</strong><br>
                <small class="text-muted">⭐ {{rating_avg}} ({{formatNumber rating_count}})</small>
              </td>
              <td>{{teacher.full_name}}</td>
              <td><span class="badge bg-primary">{{category.name}}</span></td>
              <td>
                <span
                  class="badge bg-{{#if (eq status 'published')}}success{{else if (eq status 'draft')}}warning{{else}}danger{{/if}}">
                  {{#if (eq status 'published')}}Đã xuất bản
                  {{else if (eq status 'draft')}}Bản nháp
                  {{else}}Chưa hoàn thành
                  {{/if}}
                </span>
              </td>
              <td>{{formatNumber enrollment_count}}</td>
              <td>{{formatCurrency discount_price}}</td>
              <td>
                <div class="action-buttons">
                  <a href="/courses/{{id}}" class="btn btn-sm btn-outline-primary" target="_blank">
                    <i class="bi bi-eye"></i>
                  </a>
                  <button class="btn btn-sm btn-outline-danger" onclick="removeCourse('{{id}}', '{{title}}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

</div>
{{#fill_section 'js'}}
<script>
  const courseNotifications = {
    show(message, variant = 'success') {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div class="alert alert-${variant} alert-dismissible fade show position-fixed top-0 end-0 m-3 shadow" role="alert" style="z-index:1055; min-width:260px;">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      const alertEl = wrapper.firstElementChild;
      document.body.appendChild(alertEl);
      setTimeout(() => {
        if (alertEl) bootstrap.Alert.getOrCreateInstance(alertEl).close();
      }, 4000);
    }
  };

  function updateCourseCount() {
    const rows = document.querySelectorAll('#coursesTableBody tr:not(.d-none)');
    const label = document.getElementById('coursesCount');
    if (label) label.textContent = rows.length;
  }

function filterCourses() {
    // 1. Lấy giá trị từ các bộ lọc
    const selectedCategory = document.querySelector('select[onchange="filterByCategory(this.value)"]').value;
    const selectedTeacher = document.querySelector('select[onchange="filterByTeacher(this.value)"]').value;
    const selectedStatus = document.querySelector('select[onchange="filterByStatus(this.value)"]').value;
    const searchTerm = document.getElementById('courseSearch')?.value.toLowerCase().trim() || '';

    const rows = document.querySelectorAll('#coursesTableBody tr');
    rows.forEach(row => {
      const categoryMatch = !selectedCategory || row.dataset.category === selectedCategory;
      const teacherMatch = !selectedTeacher || row.dataset.teacher === selectedTeacher;
      const statusMatch = !selectedStatus || row.dataset.status === selectedStatus;

      // Lấy nội dung của hàng để tìm kiếm
      const courseTitle = row.cells[1].querySelector('strong')?.textContent.toLowerCase() || '';
      const teacherName = row.cells[2].textContent.toLowerCase() || '';
      const categoryName = row.cells[3].textContent.toLowerCase() || '';

      // 2. Kiểm tra khớp từ khóa
      const searchMatch = !searchTerm || 
          courseTitle.includes(searchTerm) || 
          teacherName.includes(searchTerm) || 
          categoryName.includes(searchTerm);

      // 3. Ẩn/Hiện hàng
      row.classList.toggle('d-none', !(categoryMatch && teacherMatch && statusMatch && searchMatch));
    });
    updateCourseCount();
  }

  function filterByCategory(categoryId) {
    filterCourses();
  }

  function filterByTeacher(teacherId) {
    filterCourses();
  }

  function filterByStatus(status) {
    filterCourses();
  }

  async function removeCourse(courseId, courseTitle) {
    if (!confirm(`Bạn có chắc muốn gỡ bỏ khóa học "${courseTitle}"?\nKhóa học sẽ không còn hiển thị công khai.`)) return;

    try {
      const res = await fetch(`/admin/courses/${courseId}`, { method: 'DELETE' });
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'Không thể gỡ khóa học.');
      document.querySelector(`tr[data-course-id="${courseId}"]`)?.remove();
      courseNotifications.show('Đã gỡ khóa học thành công!');
      updateCourseCount();
    } catch (err) {
      courseNotifications.show(err.message || 'Có lỗi xảy ra khi gỡ khóa học.', 'danger');
    }
  }
</script>
{{/fill_section}}