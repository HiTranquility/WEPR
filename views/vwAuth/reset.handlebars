<div class="auth-container">
  <div class="auth-header">
    <h1>Reset Password</h1>
    <p>Set a new password for your account</p>
  </div>

  <div class="auth-body">
    <div id="alertMessage" class="alert alert-danger hidden"></div>

    <form id="resetForm" action="/auth/reset-password" method="POST" novalidate>
      <div class="form-group">
        <label class="form-label" for="password">New Password</label>
        <input type="password" class="form-control" id="password" name="password" required minlength="6">
        <div class="password-strength">
          <div class="password-strength-bar" id="passwordStrength"></div>
        </div>
        <div class="error-message" id="passwordError">Password must be at least 6 characters</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="confirmPassword">Confirm New Password</label>
        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
        <div class="error-message" id="confirmPasswordError">Passwords do not match</div>
      </div>

      <button type="submit" class="btn-primary" id="submitBtn">Update Password</button>
    </form>
  </div>

  <div class="auth-footer">
    <a href="/signin">Back to Sign In</a>
  </div>
</div>

{{#fill_section 'js'}}
<script>
  const form = document.getElementById('resetForm');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const passwordStrength = document.getElementById('passwordStrength');
  const alertMessage = document.getElementById('alertMessage');
  const submitBtn = document.getElementById('submitBtn');

  passwordInput.addEventListener('input', (e) => {
    const password = e.target.value;
    const strength = calculatePasswordStrength(password);

    passwordStrength.className = 'password-strength-bar';
    if (strength >= 3) passwordStrength.classList.add('strong');
    else if (strength >= 2) passwordStrength.classList.add('medium');
    else if (strength >= 1) passwordStrength.classList.add('weak');
  });

  function calculatePasswordStrength(password) {
    let strength = 0;
    if (password.length >= 6) strength++;
    if (password.length >= 10) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z\d]/.test(password)) strength++;
    return strength;
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault();

    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    alertMessage.classList.add('hidden');

    if (password.length < 6) {
      alertMessage.textContent = 'Password must be at least 6 characters';
      alertMessage.classList.remove('hidden');
      return;
    }

    if (password !== confirmPassword) {
      alertMessage.textContent = 'Passwords do not match!';
      alertMessage.classList.remove('hidden');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';

    try {
      const res = await fetch('/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      const data = await res.json();

      if (!res.ok) {
        alertMessage.textContent = data.message || 'Password reset failed!';
        alertMessage.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Update Password';
        return;
      }

      alertMessage.className = 'alert alert-success';
      alertMessage.textContent = data.message || 'Password updated successfully! Redirecting...';
      alertMessage.classList.remove('hidden');

      setTimeout(() => {
        window.location.href = '/signin';
      }, 1200);
    } catch (err) {
      alertMessage.textContent = 'Server error!';
      alertMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Password';
    }
  });
</script>
{{/fill_section}}
