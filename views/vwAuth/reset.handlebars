<div class="auth-container">
  <div class="auth-header">
    <h1>Reset Password</h1>
    <p>Set a new password for your account</p>
  </div>

  <div class="auth-body">
    <div id="alertMessage" class="alert alert-danger hidden"></div>

    <form id="resetForm" novalidate>
      <div class="form-group">
        <label class="form-label" for="password">New Password</label>
        <input type="password" class="form-control" id="password" required minlength="6">
        <div class="password-strength">
          <div class="password-strength-bar" id="passwordStrength"></div>
        </div>
        <div class="error-message" id="passwordError">Password must be at least 6 characters</div>
      </div>

      <div class="form-group">
        <label class="form-label" for="confirmPassword">Confirm New Password</label>
        <input type="password" class="form-control" id="confirmPassword" required>
        <div class="error-message" id="confirmPasswordError">Passwords do not match</div>
      </div>

      <button type="submit" class="btn-primary" id="submitBtn">Update Password</button>
    </form>
  </div>

  <div class="auth-footer">
    <a href="/signin">Back to Sign In</a>
  </div>
</div>

{{#fill_section 'js'}}
<script type="module">
  import { supabase } from '/statics/js/supabase-client.js';

  const form = document.getElementById('resetForm');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const submitBtn = document.getElementById('submitBtn');
  const alertMessage = document.getElementById('alertMessage');
  const passwordStrength = document.getElementById('passwordStrength');

  passwordInput.addEventListener('input', (e) => {
    const password = e.target.value;
    const strength = calculatePasswordStrength(password);

    passwordStrength.className = 'password-strength-bar';
    if (strength >= 3) passwordStrength.classList.add('strong');
    else if (strength >= 2) passwordStrength.classList.add('medium');
    else if (strength >= 1) passwordStrength.classList.add('weak');
  });

  function calculatePasswordStrength(password) {
    let strength = 0;
    if (password.length >= 6) strength++;
    if (password.length >= 10) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z\d]/.test(password)) strength++;
    return strength;
  }

  function showError(input, errorElement) {
    input.classList.add('error');
    errorElement.classList.add('show');
  }

  function hideError(input, errorElement) {
    input.classList.remove('error');
    errorElement.classList.remove('show');
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    alertMessage.classList.add('hidden');

    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    if (password.length < 6) {
      showError(passwordInput, document.getElementById('passwordError'));
      return;
    } else hideError(passwordInput, document.getElementById('passwordError'));

    if (password !== confirmPassword) {
      showError(confirmPasswordInput, document.getElementById('confirmPasswordError'));
      return;
    } else hideError(confirmPasswordInput, document.getElementById('confirmPasswordError'));

    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';

    try {
      const { data: { user }, error } = await supabase.auth.updateUser({
        password,
      });
      if (error) throw error;

      alertMessage.className = 'alert alert-success';
      alertMessage.textContent = 'Password updated successfully! Please sign in again.';
      alertMessage.classList.remove('hidden');

      setTimeout(() => {
        window.location.href = '/signin';
      }, 1200);
    } catch (error) {
      console.error('Reset password error:', error);
      alertMessage.className = 'alert alert-danger';
      alertMessage.textContent = error.message || 'An error occurred. Please try again.';
      alertMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Password';
    }
  });
</script>
{{/fill_section}}
