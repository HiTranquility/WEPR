<div class="auth-container">
  <div class="auth-header">
    <h1>Welcome Back</h1>
    <p>Sign in to continue learning</p>
  </div>

  <div class="auth-body">
    {{#if error}}
      <div class="alert alert-danger">{{error}}</div>
    {{/if}}

    <div class="social-login">
      <a href="/google?mode=signin" class="btn-social">
        <svg viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Google
      </a>
      <a href="/gmail?mode=signup" class="btn-social">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="24" height="24" aria-hidden="true">
          <path d="M16.58,19.1068l-12.69-8.0757A3,3,0,0,1,7.1109,5.97l9.31,5.9243L24.78,6.0428A3,3,0,0,1,28.22,10.9579Z"
            fill="#EA4335" />
          <path d="M25.5,5.5h4a0,0,0,0,1,0,0v18a3,3,0,0,1-3,3h0a3,3,0,0,1-3-3V7.5a2,2,0,0,1,2-2Z" fill="#00AC47"
            transform="translate(53.0001 32.0007) rotate(180)" />
          <path
            d="M29.4562,8.0656c-.0088-.06-.0081-.1213-.0206-.1812-.0192-.0918-.0549-.1766-.0823-.2652a2.9312,2.9312,0,0,0-.0958-.2993c-.02-.0475-.0508-.0892-.0735-.1354A2.9838,2.9838,0,0,0,28.9686,6.8c-.04-.0581-.09-.1076-.1342-.1626a3.0282,3.0282,0,0,0-.2455-.2849c-.0665-.0647-.1423-.1188-.2146-.1771a3.02,3.02,0,0,0-.24-.1857c-.0793-.0518-.1661-.0917-.25-.1359-.0884-.0461-.175-.0963-.267-.1331-.0889-.0358-.1837-.0586-.2766-.0859s-.1853-.06-.2807-.0777a3.0543,3.0543,0,0,0-.357-.036c-.0759-.0053-.1511-.0186-.2273-.018a2.9778,2.9778,0,0,0-.4219.0425c-.0563.0084-.113.0077-.1689.0193a33.211,33.211,0,0,0-.5645.178c-.0515.022-.0966.0547-.1465.0795A2.901,2.901,0,0,0,23.5,8.5v5.762l4.72-3.3043a2.8878,2.8878,0,0,0,1.2359-2.8923Z"
            fill="#FFBA00" />
          <path d="M5.5,5.5h0a3,3,0,0,1,3,3v18a0,0,0,0,1,0,0h-4a2,2,0,0,1-2-2V8.5a3,3,0,0,1,3-3Z" fill="#4285F4" />
          <path
            d="M2.5439,8.0656c.0088-.06.0081-.1213.0206-.1812.0192-.0918.0549-.1766.0823-.2652A2.9312,2.9312,0,0,1,2.7426,7.32c.02-.0475.0508-.0892.0736-.1354A2.9719,2.9719,0,0,1,3.0316,6.8c.04-.0581.09-.1076.1342-.1626a3.0272,3.0272,0,0,1,.2454-.2849c.0665-.0647.1423-.1188.2147-.1771a3.0005,3.0005,0,0,1,.24-.1857c.0793-.0518.1661-.0917.25-.1359A2.9747,2.9747,0,0,1,4.3829,5.72c.089-.0358.1838-.0586.2766-.0859s.1853-.06.2807-.0777a3.0565,3.0565,0,0,1,.357-.036c.076-.0053.1511-.0186.2273-.018a2.9763,2.9763,0,0,1,.4219.0425c.0563.0084.113.0077.169.0193a2.9056,2.9056,0,0,1,.286.0888,2.9157,2.9157,0,0,1,.2785.0892c.0514.022.0965.0547.1465.0795a2.9745,2.9745,0,0,1,.3742.21A2.9943,2.9943,0,0,1,8.5,8.5v5.762L3.78,10.9579A2.8891,2.8891,0,0,1,2.5439,8.0656Z"
            fill="#C52528" />
        </svg>

        Gmail
      </a>
    </div>

    {{!-- ✅ Form gửi trực tiếp tới Node.js --}}
    <form method="POST" action="/signin" class="signin-form">
      <div class="form-group">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" name="email" placeholder="Email Address" class="form-control" required autocomplete="username">
      </div>

      <div class="form-group">
        <label for="password" class="form-label">Password</label>
        <input type="password" name="password" placeholder="Password" class="form-control" required autocomplete="new-password">
      </div>

      <div class="form-footer">
        <div class="checkbox-group">
          <input type="checkbox" id="rememberMe">
          <label for="rememberMe">Remember me</label>
        </div>
        <a href="/forgot">Forgot password?</a>
      </div>

      <button type="submit" class="btn-primary w-100">Sign In</button>
    </form>
  </div>

  <div class="auth-footer">
    Don't have an account? <a href="/signup">Sign Up</a>
  </div>
</div>


{{#fill_section 'js'}}
<script>
  const form = document.getElementById('signinForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const submitBtn = document.getElementById('submitBtn');
  const alertMessage = document.getElementById('alertMessage');

  function showError(input, errorElement) {
    input.classList.add('error');
    errorElement.classList.add('show');
  }

  function hideError(input, errorElement) {
    input.classList.remove('error');
    errorElement.classList.remove('show');
  }

  function validateEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function validateForm() {
    let isValid = true;
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!validateEmail(email)) {
      showError(emailInput, document.getElementById('emailError'));
      isValid = false;
    } else {
      hideError(emailInput, document.getElementById('emailError'));
    }

    if (password === '') {
      showError(passwordInput, document.getElementById('passwordError'));
      isValid = false;
    } else {
      hideError(passwordInput, document.getElementById('passwordError'));
    }

    return isValid;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    alertMessage.classList.add('hidden');
    if (!validateForm()) return;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Signing in...';

    const email = emailInput.value.trim();
    const password = passwordInput.value;

    try {
      const res = await fetch('/auth/signin', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      // Nếu server trả redirect, Express có thể trả HTML, nên ta kiểm tra
      if (res.redirected) {
        window.location.href = res.url;
        return;
      }

      const data = await res.json();
      if (!res.ok || !data.success) {
        alertMessage.className = 'alert alert-danger';
        alertMessage.textContent = data.message || 'Invalid email or password.';
        alertMessage.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign In';
        return;
      }

      // Nếu backend chỉ trả JSON
      alertMessage.className = 'alert alert-success';
      alertMessage.textContent = 'Login successful! Redirecting...';
      alertMessage.classList.remove('hidden');

      setTimeout(() => {
        if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          window.location.href = '/';
        }
      }, 800);

    } catch (err) {
      console.error('Signin error', err);
      alertMessage.className = 'alert alert-danger';
      alertMessage.textContent = 'Server error. Please try again later.';
      alertMessage.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Sign In';
    }
  });
</script>
{{/fill_section}}
